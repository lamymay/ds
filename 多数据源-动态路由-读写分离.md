

大概一个场景， 
服务要去访问数据库，那就需要数据源对吧，
规划指定的服务只能访问指定的数据库【只读的去访问备库，其他的访问主库】

方案：
原理是：用注解标识标识服务方法是只读/非只读服务，然后由统一配置去分辨控制什么服务访问主备库。
最终实现：只读服务访问备库，非只读服务（插删改）访问主库，注意：主备库之间已经做同步

做法：
1. 定义注解去标识只读服务（本例子中使用了Spring提供的注解，）
2. 统一配置：（数据源，AOP，Mybatis集成）
2.1 数据源配置 
2.2 动态路由配置 
2.3  AOP切服务，绑定相应的key到线程上。目的是动态根据注解去给其设置合适的数据源完成读写分离 
2.4 动态路由选取 map（key-DataSource）

3. 测试，准备好主备库以、数据、业务方法、接口


 

过程中遇到问题：服务一直走默认的主库，
原因：
无论什么服务进来后都是获取到了 默认数据源（主库），然后数据没有走备库，
绑定数据源的时机晚于服务获取数据源，

debug 现象也说明了这点，AOP切着这些服务，当服务获取数据的时候，还没有绑定合适的数据源，则它就先去获取到了 默认数据源（主库），导致一直不走备库。实际上AOP在比较晚的时机才把合适的数据源设置给他，


人话就是，我还没有给他合适的数据源，他就早早获取了一个不合适的数据源去勾搭数据库去了


更新2019/07/28

#但是这时候会有一个奇怪的现象就是每次调用的时候会走chooseDataSource再走AOP，经查询发现是事务问题导致，因为它先走了事务切面，然后事务还没结束的时候如果再去切换数据源的话是不成立的。方法解决很简单，设置一下切换数据源的AOP的优先级，确保在事务执行之前就已经切换数据源，


#测试说明
    //测试说明 ：
    //@GetMapping("/files/{id}") 走 test5的db
    //@GetMapping("/files") 走test的db
